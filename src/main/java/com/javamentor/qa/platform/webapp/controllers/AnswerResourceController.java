package com.javamentor.qa.platform.webapp.controllers;import com.javamentor.qa.platform.models.dto.AnswerDto;import com.javamentor.qa.platform.models.entity.question.answer.Answer;import com.javamentor.qa.platform.models.util.action.OnCreate;import com.javamentor.qa.platform.models.util.action.OnUpdate;import com.javamentor.qa.platform.service.abstracts.dto.AnswerDtoService;import com.javamentor.qa.platform.service.abstracts.model.AnswerService;import com.javamentor.qa.platform.service.abstracts.model.UserService;import com.javamentor.qa.platform.webapp.converter.AnswerConverter;import io.swagger.annotations.Api;import io.swagger.annotations.ApiOperation;import io.swagger.annotations.ApiResponse;import io.swagger.annotations.ApiResponses;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.http.HttpStatus;import org.springframework.http.ResponseEntity;import org.springframework.validation.annotation.Validated;import org.springframework.web.bind.annotation.*;import javax.persistence.EntityNotFoundException;import javax.validation.ConstraintViolationException;import javax.validation.Valid;import javax.validation.constraints.NotNull;import java.time.LocalDateTime;import java.util.List;@Validated@RestController@RequestMapping(value = "/api/user/question/{questionId}/answer", produces = "application/json")@Api(value = "AnswerApi", description = "Операции с ответами (создание, изменение, получение списка, получение ответов по ID вопроса)")public class AnswerResourceController {    private final AnswerConverter answerConverter;    private final AnswerService answerService;    private final AnswerDtoService answerDtoService;    private final UserService userService;    private final Logger logger = LoggerFactory.getLogger(this.getClass());    public AnswerResourceController(AnswerConverter answerConverter, AnswerService answerService, AnswerDtoService answerDtoService, UserService userService) {        this.answerConverter = answerConverter;        this.answerService = answerService;        this.answerDtoService = answerDtoService;        this.userService = userService;    }    @ApiOperation(value = "Получение ответов по ID вопроса с сортировкой по недавно добавленным/измененным")    @ApiResponses(value = {            @ApiResponse(code = 200, message = "Ответы получены")})    @GetMapping    public ResponseEntity<List<AnswerDto>> getAnswersDtoSortNew(@PathVariable @NotNull Long questionId) {        return ResponseEntity.ok(answerDtoService.getAnswersDtoByQuestionIdSortNew(questionId));    }    @ApiOperation(value = "Получение ответов по ID вопроса с сортировкой по счетчику полезности")    @ApiResponses(value = {            @ApiResponse(code = 200, message = "Ответы получены")})    @GetMapping("/sort/count")    public ResponseEntity<List<AnswerDto>> getAnswersDtoSortCount(@PathVariable @NotNull Long questionId) {        return ResponseEntity.ok(answerDtoService.getAnswersDtoByQuestionIdSortCount(questionId));    }    @ApiOperation(value = "Получение ответов по ID вопроса с сортировкой по дате создания")    @ApiResponses(value = {            @ApiResponse(code = 200, message = "Ответы получены")})    @GetMapping("/sort/date")    public ResponseEntity<List<AnswerDto>> getAnswersDtoSortDate(@PathVariable @NotNull Long questionId) {        return ResponseEntity.ok(answerDtoService.getAnswersDtoByQuestionIdSortDate(questionId));    }    @ApiOperation(value = "Добавление ответа по ID вопроса")    @ApiResponses(value = {            @ApiResponse(code = 200, message = "Ответ добавлен"),            @ApiResponse(code = 400, message = "ID вопроса в url и в dto не совпадают")    })    @Validated(OnCreate.class)    @PostMapping    public ResponseEntity<AnswerDto> addAnswer(@RequestBody @Valid AnswerDto answerDTO,                                               @PathVariable @NotNull Long questionId) {        if (questionId.equals(answerDTO.getQuestionId())) {            Answer answer = answerConverter.dtoToAnswer(answerDTO);            answerService.persist(answer);            logger.info(String.format("Ответ к вопросу с ID: %s добавлен в базу данных", answerDTO.getQuestionId()));            return ResponseEntity.status(HttpStatus.CREATED).body(answerDTO);        } else {            logger.error(String.format("Ответ к вопросу с ID: %s не добавлен в базу данных (в url ID вопроса: %s)",                    answerDTO.getQuestionId(), questionId));            return ResponseEntity.status(400).body(answerDTO);        }    }    @ApiOperation(value = "Изменение ответа по ID вопроса и ID ответа")    @ApiResponses(value = {            @ApiResponse(code = 200, message = "Ответ изменен"),            @ApiResponse(code = 400, message = "ID вопроса или ответа в url и в dto не совпадают")    })    @Validated(OnUpdate.class)    @PutMapping("/{answerId}")    public ResponseEntity<AnswerDto> updateAnswer(@RequestBody @Valid AnswerDto answerDTO,                                                  @PathVariable @NotNull Long answerId,                                                  @PathVariable @NotNull Long questionId) {        if (questionId.equals(answerDTO.getQuestionId()) && answerId.equals(answerDTO.getId())) {            if (answerDTO.getIsHelpful()) {               Answer answer = answerService.getByKey(answerDTO.getId());               if(answer.getIsHelpful()) {                   answerDTO.setDateAcceptTime(answer.getDateAcceptTime());               }else {                   answerService.resetIsHelpful(questionId);                   answerDTO.setDateAcceptTime(LocalDateTime.now());               }                answer = answerConverter.dtoToAnswer(answerDTO);                answerService.update(answer);                logger.info(String.format("Ответ с ID: %s к вопросу с ID: %s изменен", answerDTO.getId(), answerDTO.getQuestionId()));                return ResponseEntity.ok(answerDTO);            } else answerDTO.setDateAcceptTime(null);            Answer answer = answerConverter.dtoToAnswer(answerDTO);            answerService.update(answer);            logger.info(String.format("Ответ с ID: %s к вопросу с ID: %s изменен", answerDTO.getId(), answerDTO.getQuestionId()));            return ResponseEntity.ok(answerDTO);        } else {            logger.error(String.format("Ответ с ID: %s к вопросу с ID: %s не добавлен в базу данных (в url ID ответа: %s, ID вопроса: %s)",                    answerDTO.getId(), answerDTO.getQuestionId(), answerId, questionId));            throw new UnsupportedOperationException(String.format("Ответ с ID: %s к вопросу с ID: %s не добавлен в базу данных (в url ID ответа: %s, ID вопроса: %s)",                    answerDTO.getId(), answerDTO.getQuestionId(), answerId, questionId));        }    }    @ApiOperation(value = "Удаление ответа по ID вопроса и ID ответа")    @ApiResponses(value = {            @ApiResponse(code = 200, message = "Ответ удален"),    })    @DeleteMapping("/{answerId}")    public ResponseEntity<String> deleteAnswer(@PathVariable @NotNull Long answerId, @PathVariable @NotNull Long questionId) {        answerService.setDelete(answerId);        logger.info(String.format("Ответ с ID: %s удален", answerId));        return ResponseEntity.ok().build();    }}